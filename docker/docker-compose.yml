version: '3.5'

services:

  ATL1:
    container_name: ATL1
    hostname: ATL1
    image: cockroachdb/cockroach:latest
    command: start --logtostderr --insecure --locality=region=ATL1

  ATL2:
    container_name: ATL2
    hostname: ATL2
    image: cockroachdb/cockroach:latest
    command: start --logtostderr --insecure --locality=region=ATL2 --join=ATL1
    depends_on:
      - ATL1

  TX1:
    container_name: TX1
    hostname: TX1
    image: cockroachdb/cockroach:latest
    command: start --logtostderr --insecure --locality=region=TX1 --join=ATL1
    depends_on:
      - ATL1

  TX2:
    container_name: TX2
    hostname: TX2
    image: cockroachdb/cockroach:latest
    command: start --logtostderr --insecure --locality=region=TX2 --join=ATL1
    depends_on:
      - ATL1

  lb:
    container_name: lb
    hostname: lb
    build: haproxy
    ports:
      - "5432:5432"
      - "8080:8080"
      - "8081:8081"
    links:
      - ATL1
      - ATL2
      - TX1
      - TX2

  prometheus:
    container_name: prometheus
    hostname: prometheus
    build: ./prometheus
    ports:
      - "9090:9090"
    depends_on:
      - lb

  grafana:
    container_name: grafana
    hostname: grafana
    build: ./grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus